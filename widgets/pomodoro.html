<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>专注番茄钟</title>
    <style>
        :root {
            --primary: #FF5252;
            --bg: #ffffff;
            --text: #333333;
            --surface: #f5f5f5;
            --overlay-bg: rgba(255, 255, 255, 0.95);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #FF5252;
                --bg: #1a1a1a;
                --text: #ffffff;
                --surface: #333333;
                --overlay-bg: rgba(26, 26, 26, 0.95);
            }
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, sans-serif;
            display: flex;
            user-select: none;
            cursor: default;
        }

        #app {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* --- Main Timer Interface --- */
        .ring-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Adaptive size base */
            width: 70vmin;
            height: 70vmin;
            transition: all 0.3s ease;
        }

        svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            fill: none;
            stroke-width: 6;
            stroke-linecap: round;
        }

        .bg-ring {
            stroke: var(--surface);
        }

        .progress-ring {
            stroke: var(--primary);
        }

        .timer-text {
            position: absolute;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            font-size: 16vmin;
            z-index: 1;
        }

        /* Controls Panel */
        .controls {
            position: absolute;
            bottom: 10%;
            display: flex;
            gap: 4vmin;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.2s ease;
            z-index: 2;
        }

        /* Always show controls if paused, or on hover */
        #app:hover .controls,
        #app.paused .controls {
            opacity: 1;
            transform: translateY(0);
        }

        /* In layout-large (2x2), controls are static below ring */
        body.layout-large .controls {
            position: static;
            margin-top: 4vmin;
            opacity: 1;
            transform: none;
        }

        .btn {
            background: var(--surface);
            color: var(--text);
            border: none;
            border-radius: 50%;
            width: 12vmin;
            height: 12vmin;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 6vmin;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn.primary {
            background: var(--primary);
            color: white;
        }

        .btn.icon-only {
            font-family: sans-serif;
        }

        /* Settings Toggle Button (Top Right corner) */
        .settings-btn {
            position: absolute;
            top: 2vmin;
            right: 2vmin;
            background: transparent;
            border: none;
            color: var(--text);
            opacity: 0.3;
            cursor: pointer;
            padding: 2vmin;
            z-index: 5;
            font-size: 5vmin;
        }

        .settings-btn:hover {
            opacity: 1;
        }

        /* Settings Overlay */
        .settings-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay-bg);
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            backdrop-filter: blur(5px);
        }

        .settings-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .settings-title {
            font-size: 4vmin;
            margin-bottom: 4vmin;
            font-weight: bold;
        }

        .time-presets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2vmin;
            width: 80%;
            margin-bottom: 4vmin;
        }

        .preset-btn {
            padding: 2vmin;
            background: var(--surface);
            border: 1px solid transparent;
            border-radius: 8px;
            color: var(--text);
            font-size: 4vmin;
            cursor: pointer;
            text-align: center;
        }

        .preset-btn.active {
            border-color: var(--primary);
            color: var(--primary);
            font-weight: bold;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 2vmin;
            margin-bottom: 4vmin;
        }

        .custom-input {
            width: 20vmin;
            padding: 2vmin;
            border: 1px solid var(--surface);
            border-radius: 8px;
            background: rgba(128, 128, 128, 0.1);
            color: var(--text);
            text-align: center;
            font-size: 5vmin;
        }

        /* Stats (Only visible in large layout) */
        .stats {
            margin-top: 2vmin;
            font-size: 3vmin;
            opacity: 0.7;
            display: none;
        }

        /* 2x1 Layout Tweaks */
        @media (aspect-ratio: 2/1) {
            #app {
                flex-direction: row;
                gap: 4vmin;
                justify-content: space-evenly;
            }

            .ring-container {
                width: 40vmin;
                height: 40vmin;
                margin: 0;
            }

            .timer-text {
                font-size: 10vmin;
            }

            .controls {
                position: static;
                flex-direction: column;
                opacity: 1 !important;
                transform: none !important;
                gap: 2vmin;
            }

            .btn {
                width: 10vmin;
                height: 10vmin;
                font-size: 5vmin;
            }

            .settings-btn {
                font-size: 4vmin;
            }
        }

        body.layout-large .stats {
            display: block;
        }

        body.layout-large .ring-container {
            width: 45vmin;
            height: 45vmin;
        }

        body.layout-large .timer-text {
            font-size: 10vmin;
        }
    </style>
</head>

<body>
    <div id="app" class="paused">
        <button class="settings-btn" id="openSettings">⚙</button>

        <div class="ring-container">
            <svg viewBox="0 0 100 100">
                <circle class="bg-ring" cx="50" cy="50" r="45"></circle>
                <circle class="progress-ring" cx="50" cy="50" r="45" stroke-dasharray="283" stroke-dashoffset="0">
                </circle>
            </svg>
            <div class="timer-text" id="time">25:00</div>
        </div>

        <div class="controls">
            <button class="btn" id="resetBtn" title="Reset">↻</button>
            <button class="btn primary" id="toggleBtn" title="Start/Pause">▶</button>
        </div>

        <div class="stats" id="stats">
            今日专注: <span id="sessionCount">0</span> 次
        </div>

        <!-- Settings Overlay -->
        <div class="settings-overlay" id="settingsOverlay">
            <div class="settings-title">时长设置 (分钟)</div>
            <div class="time-presets">
                <button class="preset-btn" data-time="5">5</button>
                <button class="preset-btn active" data-time="25">25</button>
                <button class="preset-btn" data-time="45">45</button>
            </div>
            <div class="input-group">
                <span>自定义:</span>
                <input type="number" class="custom-input" id="customTimeInput" value="25" min="1" max="180">
            </div>
            <button class="btn primary" id="saveSettings"
                style="width: auto; padding: 0 6vmin; font-size: 4vmin; height: 10vmin; border-radius: 8px;">
                完成
            </button>
        </div>
    </div>

    <script>
        const FULL_DASH_ARRAY = 283;

        // State
        let selectedDuration = 25; // Minutes
        let timeLeft = 25 * 60;
        let isRunning = false;
        let sessions = 0;
        let timerInterval = null;
        let startTime = null;
        let cachedTimeLeft = timeLeft;

        // Elements
        const app = document.getElementById('app');
        const timeLabel = document.getElementById('time');
        const circle = document.querySelector('.progress-ring');
        const toggleBtn = document.getElementById('toggleBtn');
        const resetBtn = document.getElementById('resetBtn');
        const sessionCount = document.getElementById('sessionCount');
        const overlay = document.getElementById('settingsOverlay');
        const customInput = document.getElementById('customTimeInput');

        // Layout Detection
        function updateLayout() {
            const isLarge = Math.min(window.innerWidth, window.innerHeight) > 180;
            if (isLarge) document.body.classList.add('layout-large');
            else document.body.classList.remove('layout-large');
        }
        window.addEventListener('resize', updateLayout);
        updateLayout();

        // --- Core Logic ---

        function init() {
            loadState();
            updateInterface();
            setupSettings();
        }

        function loadState() {
            try {
                const saved = JSON.parse(localStorage.getItem('pomodoro_state_v2') || '{}');
                if (saved.duration) selectedDuration = saved.duration;
                if (saved.timeLeft !== undefined) timeLeft = saved.timeLeft;
                if (saved.sessions) sessions = saved.sessions;

                cachedTimeLeft = timeLeft;
                sessionCount.textContent = sessions;

                // Update Settings UI
                customInput.value = selectedDuration;
                updatePresetHighlight(selectedDuration);
            } catch (e) { }
        }

        function saveState() {
            localStorage.setItem('pomodoro_state_v2', JSON.stringify({
                duration: selectedDuration,
                timeLeft,
                sessions,
                timestamp: Date.now()
            }));
        }

        function formatTime(time) {
            const m = Math.floor(time / 60);
            const s = time % 60;
            return `${m}:${s < 10 ? '0' + s : s}`;
        }

        function updateInterface() {
            timeLabel.innerHTML = formatTime(timeLeft);

            const totalSeconds = selectedDuration * 60;
            const rawFraction = timeLeft / totalSeconds;
            // Prevent division by zero
            if (totalSeconds === 0) return;

            const offset = (FULL_DASH_ARRAY * (1 - rawFraction)).toFixed(0);
            circle.style.strokeDashoffset = offset;
        }

        function startTimer() {
            if (isRunning) return;
            isRunning = true;
            toggleBtn.innerHTML = '⏸';
            app.classList.remove('paused');

            startTime = Date.now();
            // Refreeze cachedTimeLeft to current displayed time to resume correctly
            cachedTimeLeft = timeLeft;

            timerInterval = setInterval(() => {
                const now = Date.now();
                const delta = Math.floor((now - startTime) / 1000);
                timeLeft = cachedTimeLeft - delta;

                if (timeLeft <= 0) {
                    timeLeft = 0;
                    onTimesUp();
                }
                updateInterface();
                saveState();
            }, 1000);
        }

        function pauseTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            toggleBtn.innerHTML = '▶';
            app.classList.add('paused');
            saveState();
        }

        function resetTimer() {
            pauseTimer();
            timeLeft = selectedDuration * 60;
            cachedTimeLeft = timeLeft;
            updateInterface();
            saveState();
        }

        function onTimesUp() {
            pauseTimer();
            sessions++;
            sessionCount.textContent = sessions;
            timeLeft = selectedDuration * 60; // Auto reset to start
            cachedTimeLeft = timeLeft;
            updateInterface();
            saveState();

            // Notification sound could play here
        }

        // --- Settings Logic ---

        function setupSettings() {
            const presets = document.querySelectorAll('.preset-btn');
            presets.forEach(btn => {
                btn.onclick = () => {
                    const t = parseInt(btn.dataset.time);
                    customInput.value = t;
                    selectDuration(t);
                };
            });

            document.getElementById('openSettings').onclick = () => {
                overlay.classList.add('active');
            };

            document.getElementById('saveSettings').onclick = () => {
                let val = parseInt(customInput.value);
                if (val < 1) val = 1;
                if (val > 180) val = 180;
                selectDuration(val);
                overlay.classList.remove('active');
            };
        }

        function selectDuration(minutes) {
            selectedDuration = minutes;
            updatePresetHighlight(minutes);

            // Only force reset if not running, or user explicitly requested via save
            // Here we enforce reset on setting change for simplicity
            if (!isRunning) {
                timeLeft = selectedDuration * 60;
                cachedTimeLeft = timeLeft;
                updateInterface();
                saveState();
            }
        }

        function updatePresetHighlight(minutes) {
            document.querySelectorAll('.preset-btn').forEach(b => {
                b.classList.toggle('active', parseInt(b.dataset.time) === minutes);
            });
        }

        // --- Events ---
        toggleBtn.onclick = () => isRunning ? pauseTimer() : startTimer();
        resetBtn.onclick = resetTimer;

        init();
    </script>
</body>

</html>